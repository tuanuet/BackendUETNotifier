<% layout('../layout') -%>
<% stylesheet("https://cdnjs.cloudflare.com/ajax/libs/froala-editor/2.7.5/css/froala_style.min.css")%>
<% stylesheet("/css/detail-announcement.css")%>

<div class="content-page">
    <!-- Start content -->
    <div class="content">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card-box table-responsive">
                        <h4 class="m-t-0 header-title"><b>Announcement</b></h4>

                        <div class="col-lg-6">
                            <div class="member-info">
                                <h4 class="m-t-0">Tiêu đề: <b><%= announcement.title%></b></h4>
                                <p class="text-dark m-b-5"><b>Miêu tả: </b><%= announcement.description%></p>
                                <p class="text-dark m-b-5"><b>Tên người đăng: </b><%= announcement.sender.name%></p>
                                <p class="text-dark m-b-0"><b>Thời gian: </b><%= announcement.createdAt%></p>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <h4 class="m-t-0">&nbsp;</h4>
                            <p class="text-dark m-b-5"><b>Loại thông báo:</b> <%= announcement.kindOfAnnouncement.name%></p>
                            <p class="text-dark m-b-5"><b>Mức độ:</b><%= announcement.priorityNotify.name%></p>
                            <p class="text-dark m-b-0"><b>Loại người nhận:</b><%=announcement.kindOfReceiver%></p>
                        </div>

                        <div class="col-lg-12">
                            <p class="text-dark m-b-5">Có <b><%= `${announcement.reaction.surprise.length +
                                    announcement.reaction.wow.length +
                                    announcement.reaction.love.length+
                                    announcement.reaction.angry.length+
                                    announcement.reaction.cry.length}` %></b> lượt bày tỏ cảm xúc</p>
                        </div>

                        <div class="col-lg-8 col-lg-offset-2">
                            <br>
                            <div class="fr-view">
                                <%- announcement.content %>
                            </div>
                        </div>
                    </div>
                </div> <!-- end col -->
                <div class="col-lg-12">
                    <div class="card-box">
                        <!--area textbox chat-->
                        <label>Gửi cho: <span id="send-to"></span> <span class="remove">X</span></label>
                        <div class="comment-wrap">
                            <div class="photo">
                                <div class="avatar" style="background-image: url('/images/logo2_new.png')"></div>
                            </div>
                            <div class="comment-block">
                                <form action="">
                                    <textarea name="content" cols="30" rows="3" placeholder="Add comment..."></textarea>
                                </form>
                            </div>
                        </div>
                        <div class="comments-container">
                            <ul id="comments-list" class="comments-list">
                                <% _.each(feedbacks,feedback => { %>
                                    <% if(_.isNull(feedback.subFeedback)){ %>
                                    <li data-id="<%= feedback._id%>">
                                    <div class="comment-main-level">
                                        <div class="comment-avatar"><img src= <%= feedback.sender._id.toString() === user._id.toString() ? "/images/logo2_new.png" : "/images/user.png"%> alt=""></div>
                                        <div class="comment-box">
                                            <div class="comment-head">
                                                <h6 class="comment-name by-author"><a href="#"><%= `${feedback.sender.name} (${feedback.sender.code?  feedback.sender.code : ''})` %></a></h6><span class="badge-kind-sender"><%= feedback.kindSender%></span>
                                                <span class="timer"><%= helper.getMomentTime(feedback.createdAt,true)%></span>
                                                <i data-value="<%= feedback._id%>" class="fa fa-reply"></i>
                                            </div>
                                            <div class="comment-content">
                                                <p><%= feedback.content %></p>
                                            </div>
                                        </div>
                                    </div>
                                    <ul class="comments-list reply-list">
                                        <%
                                            const subs = _(feedbacks)
                                                    .filter(item => item.subFeedback)
                                                    .filter(item => item.subFeedback.toString() === feedback._id.toString())
                                                    .value();
                                        %>
                                        <% _.each(subs,sub => { %>
                                        <li data-id="<%= sub._id%>">
                                            <!-- Avatar -->
                                            <div class="comment-avatar"><img src="<%= sub.sender._id.toString() === user._id.toString() ? "/images/logo2_new.png" : "/images/user.png"%>" alt=""></div>
                                            <div class="comment-box">
                                                <div class="comment-head">
                                                    <h6 class="comment-name by-author"><a href="#"><%= `${sub.sender.name} (${sub.sender.code?  sub.sender.code: ''})` %></a></h6><span class="badge-kind-sender"><%= sub.kindSender%></span>
                                                    <span class="timer"><%= helper.getMomentTime(sub.createdAt,true)%></span>
                                                    <i data-value="<%= sub.subFeedback%>" class="fa fa-reply"></i>
                                                </div>
                                                <div class="comment-content">
                                                    <p><%= sub.content %></p>
                                                </div>
                                            </div>
                                        </li>
                                        <% })%>
                                    </ul>
                                </li>
                                    <%}%>
                                <% }) %>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- container -->
    </div> <!-- content -->
    <footer class="footer text-right">
        © 2017. All rights reserved.
    </footer>
</div>
<script type="text/javascript">
    $(document).ready(function() {
        var rootId = "";
        $(document).on('click','.fa-reply',function () {
            var _rootId = $(this).attr('data-value').toString();
            rootId = _rootId;
            var _name = $(this).parent().find('.by-author a').text()
            $('#send-to').text(_name);
        })

        $(document).on('click','.remove',function () {
            rootId = "";
            $('#send-to').text("");
        })
        $('textarea[name=content]').keypress(function(e) {
            if(e.which == 13) {
                var _rootId = rootId;
                var _data = {
                    announcementId : "<%= idAnnounce%>",
                    content: $('textarea[name=content]').val(),
                    isSub: _rootId !== "",
                    rootId: _rootId
                }

                $.ajax({
                    method: 'POST',
                    data: _data,
                    url: `/test/feedback`,
                    success: function (feedback) {
                        var block;
                        if(_rootId !== ""){
                            block= subBlock(feedback);
                            $("li[data-id='" + _rootId + "']").find('ul').append(block);
                        } else {
                            block = parentBlock(feedback);
                            $("#comments-list").append(block);
                        }
                        rootId = "";
                        $('#send-to').text("");
                        $('textarea[name=content]').val("")
                    }
                });
            }
        });

        function parentBlock(feedback) {
            return `
            <li data-id="${feedback._id}">
            <div class="comment-main-level">
                <div class="comment-avatar"><img src="http://i9.photobucket.com/albums/a88/creaticode/avatar_1_zps8e1c80cd.jpg" alt=""></div>
                <div class="comment-box">
                    <div class="comment-head">
                        <h6 class="comment-name by-author"><a href="http://creaticode.com/blog">${feedback.sender.name} (${feedback.sender.code?  feedback.sender.code : ''})</a></h6><span class="badge-kind-sender">${feedback.kindSender}</span>
                        <span class="timer">${feedback.createdAt}</span>
                        <i data-value="${feedback._id}" class="fa fa-reply"></i>
                    </div>
                    <div class="comment-content">
                        <p>${feedback.content}</p>
                    </div>
                </div>
            </div>
            <ul class="comments-list reply-list">

            </ul>
            </li>`
        }
        function subBlock(sub) {
            return `
            <li data-id="${sub._id}">
                <div class="comment-avatar"><img src="http://i9.photobucket.com/albums/a88/creaticode/avatar_2_zps7de12f8b.jpg" alt=""></div>
                <div class="comment-box">
                <div class="comment-head">
                <h6 class="comment-name by-author"><a href="http://creaticode.com/blog">${sub.sender.name} (${sub.sender.code?  sub.sender.code :  ''})</a></h6><span class="badge-kind-sender">${sub.kindSender}</span>
                <span class="timer">${sub.createdAt}</span>
                <i data-value="${sub.subFeedback}" class="fa fa-reply"></i>
                </div>
                <div class="comment-content">
                <p>${sub.content}</p>
                </div>
                </div>
                </li>
            `;
        }
    });
</script>





