<% layout('../layout') -%>
<div class="content-page">
    <!-- Start content -->
    <div class="content">
        <div class="container">

            <!-- Page-Title -->
            <div class="row">
                <div class="col-sm-12">
                    <h4 class="page-title">Customers</h4>
                    <ol class="breadcrumb">
                        <li>
                            <a href="#">Lecturer</a>
                        </li>
                        <li>
                            <a href="#">Manage</a>
                        </li>
                        <li class="active">
                            Courses
                        </li>
                    </ol>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="card-box">
                        <button class="btn btn-primary" data-toggle="modal" data-target="#modal-my-course" data-animation="fadein">Lớp môn học của tôi</button>
                        <div class="table-responsive">
                            <table id="datatable" class="table table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Created at</th>
                                    <th>Action</th>
                                </tr>
                                </thead>

                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div> <!-- end col -->
            </div>
        </div> <!-- container -->

    </div> <!-- content -->
    <footer class="footer text-right">
        © 2017. All rights reserved.
    </footer>
</div>


<!-- sample modal content -->
<div id="modal-my-course" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="myModalLabel">Lớp môn học của tôi</h4>
            </div>
            <div class="modal-body">
                <table class="table table-bordered m-0">

                    <thead>
                    <tr>
                        <th>Id</th>
                        <th>Tên lớp môn học</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary waves-effect waves-light">Save changes</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<script src="/js/lib/lodash.js"></script>
<script>
    function postRegisterCourse(idCourse,isAdd,callback) {
        $.ajax({
            method: 'POST',
            data: {idCourse : idCourse,isAdd : isAdd},
            url: `/lecturer/register/course`,
            success: callback
        });
    }
    $(document).ready(function () {
        var myCourses= [];
        $(document).on("click",'#modal-my-course table button',function () {
            var idCourse = $(this).attr('data-value');
            var _that = this;
            postRegisterCourse(idCourse,false,function (data) {
                if(data.ok === 1){
                    myCourses = myCourses.filter(function (course) {
                        return course._id !== idCourse;
                    });

                    $(_that).parent().parent().empty();
                    $('#datatable').find('tr button[data-value="'+idCourse+'"]')
                        .addClass("btn-primary").removeClass("btn-danger").attr("disabled",false).find("i").addClass("fa-paint-brush").removeClass("fa-pencil")
                }
            })
        })

        $.ajax({
            method: 'GET',
            url: `/lecturer/courses`,
            success: function (courses) {
                myCourses = courses;
                _.each(courses,function(course,index){
                    $("#modal-my-course").find('tbody').append(
                        "<tr>\n" +
                        "  <td>"+ course._id +"</td>\n" +
                        "  <td>"+ course.name +"</td>\n" +
                        "  <td>" +
                        "       <button class=\"btn btn-danger waves-effect waves-light btn-edit\" data-value=\""+  course._id + "\">" +
                        "           <i class=\"fa fa-pencil\"></i>" +
                        "       </button>" +
                        "  </td>\n" +
                        "</tr>")
                })

                var table = $('#datatable').dataTable({
                    processing:true,
                    serverSide: true,
                    ajax: '/lecturer/manage/courses/datatable',
                    columns:[
                        {data: '_id', name: '_id',},
                        {data: 'name', name: 'name'},
                        {data: 'term.name', name: 'term'},
                        {data: 'action', name: 'action',render: function (data, type, row) {
                                return '<button class="btn btn-primary waves-effect waves-light btn-edit" data-value="'+ row._id+'"><i class="fa fa-paint-brush"></i></button>'
                            }},
                    ],
                    drawCallback: function (setting) {
                        function isRegister(row){
                            return _.some(myCourses,function (course) {
                                return course._id === row._id
                            })
                        }
                        _.each(setting.json.data,function (row) {
                            if (isRegister(row)) {
                                $('#datatable').find('tr button[data-value="'+row._id+'"]')
                                    .removeClass('btn-primary').addClass('btn-danger').attr("disabled","disabled").find('i').removeClass("fa-paint-brush").addClass("fa-pencil")
                            }
                        })

                    }
                });
                $(document).on('click','#datatable button',function () {
                    $(this).removeClass("btn-primary").addClass("btn-danger").attr("disabled","disabled").find("i").removeClass("fa-paint-brush").addClass("fa-pencil")
                    var _data = table.api().row($(this).parents('tr')).data();

                    myCourses.push(_data)

                    postRegisterCourse(_data._id,true,function (data) {
                        if(data.ok === 1){
                            $("#modal-my-course").find('tbody').append(
                                "<tr>\n" +
                                "  <td>"+ _data._id +"</td>\n" +
                                "  <td>"+ _data.name +"</td>\n" +
                                "  <td>" +
                                "       <button class=\"btn btn-danger waves-effect waves-light btn-edit\" data-value=\""+  _data._id + "\">" +
                                "           <i class=\"fa fa-pencil\"></i>" +
                                "       </button>" +
                                "  </td>\n" +
                                "</tr>")
                        }
                    })
                });
            }
        });




    });

</script>
